<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kupika â€” Premium Shopping List</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link
    href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20,300,0,0"
    rel="stylesheet" />
  <style type="text/tailwindcss">
    @layer base {
      body {
        @apply bg-[#0c0d10] text-[#e2e4e9] antialiased selection:bg-[#4ade80]/30;
        font-family: 'Nunito', sans-serif;
      }
    }
    :root {
      --bg-deep: #020202;
      --surface: #111111;
      --surface-glass: rgba(17, 17, 17, 0.7);
      --border-subtle: rgba(255, 255, 255, 0.05);
      --accent-primary: #3df29c;
      --accent-secondary: #35fada;
      --text-muted: #888888;
    }
    .glass-card {
      @apply bg-[var(--surface-glass)] backdrop-blur-3xl border border-[var(--border-subtle)] rounded-[24px] shadow-2xl;
    }
    .premium-input {
      @apply bg-[#111111] border border-[var(--border-subtle)] focus:border-[var(--accent-primary)] focus:ring-0 rounded-2xl transition-all duration-300 placeholder:text-[#535d72] text-sm py-4 px-5;
    }
    .mono {
      font-family: 'JetBrains Mono', monospace;
    }
    .currency-p {
      @apply font-black;
      font-family: 'Inter', sans-serif;
      scale: 1.1;
      margin-left: 2px;
    }
    .segmented-bar {
      display: flex;
      gap: 2px;
      height: 6px;
      width: 100%;
    }
    .segment {
      flex: 1;
      height: 100%;
      background: #1a1a1a;
      border-radius: 1px;
    }
    .segment.filled {
      background: linear-gradient(to right, var(--accent-primary), var(--accent-secondary));
    }
    .avatar-stack {
      display: flex;
      align-items: center;
    }
    .avatar {
      @apply w-6 h-6 rounded-full border-2 border-[#111111] -ml-2 first:ml-0 overflow-hidden;
    }
    .nav-active {
      @apply text-[var(--accent-primary)];
    }
    .btn-action-circle {
      @apply w-10 h-10 rounded-full flex items-center justify-center bg-[#1a1a1a] text-white hover:bg-[#252525] transition-colors border border-[var(--border-subtle)];
    }
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }

    /* Keep old structural animations that we still need inside JS */
    .toast-wrap {
      position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
      z-index: 500; display: flex; flex-direction: column; gap: 8px;
      align-items: center; pointer-events: none;
    }
    .toast {
      background: var(--surface); border: 1px solid var(--border-subtle);
      border-radius: 12px; padding: 11px 20px; font-size: 14px; font-weight: 700;
      box-shadow: 0 4px 24px rgba(0,0,0,0.4); white-space: nowrap;
      animation: toast-in .25s ease;
    }
    .toast.ok { border-color: var(--accent-primary); color: var(--accent-primary); }
    .toast.err { border-color: #f87171; color: #f87171; }
    @keyframes toast-in { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
    @keyframes scan-anim { 0%, 100% { top: 10%; } 50% { top: 85%; } }
  </style>
  <style>
    body {
      min-height: max(884px, 100dvh);
    }

    /* Fix iOS Safari auto-zoom on input focus (triggers when font-size < 16px) */
    input,
    select,
    textarea {
      font-size: 16px !important;
    }

    /* Hide scrollbar for smooth lists */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
</head>

<body class="min-h-screen flex flex-col">
  <div id="app" class="flex flex-col min-h-screen">
    <div style="display:flex;align-items:center;justify-content:center;height:100vh;">
      <div class="w-12 h-12 rounded-2xl border-2 border-emerald-500/20 border-t-emerald-500 animate-spin"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp }
      from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js"
    import {
      getFirestore, collection, query, where, orderBy,
      onSnapshot, addDoc, updateDoc, deleteDoc, doc, serverTimestamp
    }
      from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js"
    import { getAuth, signInAnonymously, onAuthStateChanged }
      from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js"

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // âš ï¸ Ð’Ð¡Ð¢ÐÐ’Ð¬Ð¢Ð• Ð¡Ð’ÐžÐ™ CONFIG (Firebase Console â†’ Project Settings â†’ General)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const firebaseConfig = {
      apiKey: "AIzaSyDgJPFULJSK9_V__2OcTbKY8ZrRzUz8mCE",
      authDomain: "kupika-e33ef.firebaseapp.com",
      projectId: "kupika-e33ef",
      storageBucket: "kupika-e33ef.firebasestorage.app",
      messagingSenderId: "153054761187",
      appId: "1:153054761187:web:d94088d86e1c404965f5d6"
    }

    const fbApp = initializeApp(firebaseConfig)
    const db = getFirestore(fbApp)
    const auth = getAuth(fbApp)

    // â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const CATS = [
      { id: 'produce', label: 'ðŸ¥¦ ÐžÐ²Ð¾Ñ‰Ð¸ Ð¸ Ñ„Ñ€ÑƒÐºÑ‚Ñ‹' },
      { id: 'dairy', label: 'ðŸ¥› ÐœÐ¾Ð»Ð¾Ñ‡Ð½Ð¾Ðµ' },
      { id: 'meat', label: 'ðŸ¥© ÐœÑÑÐ¾ Ð¸ Ñ€Ñ‹Ð±Ð°' },
      { id: 'bakery', label: 'ðŸž Ð¥Ð»ÐµÐ± / Ð²Ñ‹Ð¿ÐµÑ‡ÐºÐ°' },
      { id: 'drinks', label: 'ðŸ¥¤ ÐÐ°Ð¿Ð¸Ñ‚ÐºÐ¸' },
      { id: 'other', label: 'ðŸ›’ Ð”Ñ€ÑƒÐ³Ð¾Ðµ' },
    ]
    const UNITS = ['ÑˆÑ‚.', 'ÐºÐ³', 'Ð³', 'Ð»', 'Ð¼Ð»', 'ÑƒÐ¿.', 'Ð±ÑƒÑ‚.', 'Ð¿Ð°Ñ‡.']

    // â”€â”€ Open Food Facts lookup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function lookupBarcode(barcode) {
      if (!barcode) return null
      try {
        const res = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}.json`)
        const data = await res.json()
        if (data && data.status === 1 && data.product) {
          const p = data.product
          const title = p.product_name_ru || p.product_name || p.generic_name || ''
          const brand = p.brands || ''

          // ÐŸÑ€Ð¾ÑÑ‚ÐµÐ¹ÑˆÐ°Ñ ÑÐ²Ñ€Ð¸ÑÑ‚Ð¸ÐºÐ° ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¹ Ð¿Ð¾ Ñ‚ÐµÐ³Ð°Ð¼ OFF
          let category = 'other'
          const tags = (p.categories_tags || []).join(' ').toLowerCase()
          if (tags.includes('dairy') || tags.includes('milk') || tags.includes('cheese')) category = 'dairy'
          else if (tags.includes('meat') || tags.includes('poultry') || tags.includes('fish') || tags.includes('seafood')) category = 'meat'
          else if (tags.includes('plant-based') || tags.includes('vegetable') || tags.includes('fruit')) category = 'produce'
          else if (tags.includes('bread') || tags.includes('bakery') || tags.includes('pastries')) category = 'bakery'
          else if (tags.includes('beverage') || tags.includes('drink')) category = 'drinks'

          return { title, brand, category, offers: [] }
        }
      } catch (e) {
        console.warn('Open Food Facts lookup failed', e)
      }
      return null
    }

    // â”€â”€ DOM HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const genId = () => Math.random().toString(36).slice(2) + Date.now().toString(36)
    function h(tag, props, ...kids) {
      const el = document.createElement(tag)
      for (const [k, v] of Object.entries(props || {})) {
        if (k === 'className') el.className = v
        else if (k === 'style' && typeof v === 'string') el.style.cssText = v
        else if (k.startsWith('on')) el.addEventListener(k.slice(2).toLowerCase(), v)
        else el.setAttribute(k, v)
      }
      for (const c of kids.flat()) {
        if (c == null || c === false) continue
        el.append(typeof c === 'string' ? document.createTextNode(c) : c)
      }
      return el
    }

    // â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const toastWrap = h('div', { className: 'toast-wrap' })
    document.body.appendChild(toastWrap)
    function toast(msg, type = 'ok') {
      const t = h('div', { className: `toast ${type}` }, msg)
      toastWrap.prepend(t)
      setTimeout(() => t.remove(), 2800)
    }

    // â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _modal = null
    function openModal(nodes) {
      closeModal()
      const ov = h('div', {
        className: 'fixed inset-0 z-[500] bg-[#0c0d10]/80 backdrop-blur-sm flex items-end sm:items-center justify-center transition-opacity duration-300',
        onClick: e => { if (e.target === ov) closeModal() }
      })
      ov.appendChild(h('div', {
        className: 'w-full max-w-lg bg-[var(--surface)] sm:rounded-3xl rounded-t-3xl border sm:border-[var(--border-subtle)] border-t-[var(--border-subtle)] border-x-0 border-b-0 p-6 shadow-2xl relative',
        style: 'animation: slide-up .28s ease;'
      },
        h('div', { className: 'w-12 h-1.5 bg-[#2e3447] rounded-full mx-auto mb-6 sm:hidden pointer-events-none' }),
        ...nodes
      ))
      document.body.appendChild(ov)
      _modal = ov
    }
    function closeModal() { if (_modal) { _modal.remove(); _modal = null } }

    // â”€â”€ SVG ICONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function svg(paths) {
      const s = document.createElementNS('http://www.w3.org/2000/svg', 'svg')
      s.setAttribute('width', '18'); s.setAttribute('height', '18')
      s.setAttribute('viewBox', '0 0 24 24'); s.setAttribute('fill', 'none')
      s.setAttribute('stroke', 'currentColor'); s.setAttribute('stroke-width', '2')
      s.setAttribute('stroke-linecap', 'round'); s.setAttribute('stroke-linejoin', 'round')
      s.innerHTML = paths
      return s
    }
    const icoTrash = () => svg('<polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/>')
    const icoBack = () => svg('<path d="M19 12H5M12 5l-7 7 7 7"/>')
    const icoScan = () => svg('<rect x="3" y="3" width="5" height="5"/><rect x="16" y="3" width="5" height="5"/><rect x="3" y="16" width="5" height="5"/><line x1="21" y1="16" x2="21" y2="21"/><line x1="16" y1="21" x2="21" y2="21"/><line x1="12" y1="3" x2="12" y2="8"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="12" y1="16" x2="12" y2="21"/>')
    function icoWA() {
      const s = document.createElementNS('http://www.w3.org/2000/svg', 'svg')
      s.setAttribute('width', '18'); s.setAttribute('height', '18')
      s.setAttribute('viewBox', '0 0 24 24'); s.setAttribute('fill', 'currentColor')
      s.innerHTML = '<path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 0C5.373 0 0 5.373 0 12c0 2.106.549 4.09 1.51 5.816L.057 24l6.304-1.654A11.94 11.94 0 0012 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 21.818a9.835 9.835 0 01-5.012-1.373l-.36-.214-3.738.98 1.001-3.647-.235-.374A9.834 9.834 0 012.149 12C2.149 6.56 6.56 2.149 12 2.149S21.851 6.56 21.851 12c0 5.44-4.411 9.818-9.851 9.818z"/>'
      return s
    }
    const chkSvg = '<svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2 6L5 9L10 3" stroke="#071a0e" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>'

    // â”€â”€ BARCODE SCANNER (ZXing + WebWorker) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //
    // ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°: Camera â†’ Video â†’ Canvas (ROI) â†’ WebWorker (ZXing) â†’ Main Thread
    // Worker ÑÐ¾Ð·Ð´Ð°Ñ‘Ñ‚ÑÑ ÐºÐ°Ðº Blob URL â€” Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð½Ðµ Ð½ÑƒÐ¶ÐµÐ½
    //
    let _scanStream = null
    let _scanWorker = null

    function _createScanWorker() {
      // ÐšÐ¾Ð´ Ð²Ð¾Ñ€ÐºÐµÑ€Ð° â€” Ð±ÑƒÐ´ÐµÑ‚ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÑ‚ÑŒÑÑ Ð² Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾Ð¼ Ð¿Ð¾Ñ‚Ð¾ÐºÐµ
      // ZXing Ð¿Ð¾Ð´Ð³Ñ€ÑƒÐ¶Ð°ÐµÑ‚ÑÑ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ Ð²Ð¾Ñ€ÐºÐµÑ€Ð° Ñ‡ÐµÑ€ÐµÐ· importScripts
      const workerCode = `
        importScripts('https://cdn.jsdelivr.net/npm/@zxing/library@0.21.3/umd/index.min.js');

        const ZXing = self.ZXing || self['@zxing/library'] || self.zxing;
        let reader = null;

        function initReader() {
          try {
            const hints = new Map();
            hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
              ZXing.BarcodeFormat.EAN_13,
              ZXing.BarcodeFormat.EAN_8,
              ZXing.BarcodeFormat.UPC_A,
              ZXing.BarcodeFormat.UPC_E,
              ZXing.BarcodeFormat.CODE_128,
              ZXing.BarcodeFormat.CODE_39,
            ]);
            hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
            reader = new ZXing.MultiFormatReader();
            reader.setHints(hints);
            self.postMessage({ type: 'ready' });
          } catch(e) {
            self.postMessage({ type: 'error', msg: e.message });
          }
        }

        self.onmessage = (e) => {
          if (e.data.type === 'init') { initReader(); return; }
          if (e.data.type === 'decode') {
            if (!reader) return;
            const { pixels, width, height } = e.data;
            try {
              const src = new ZXing.RGBLuminanceSource(pixels, width, height);
              const bitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(src));
              const result = reader.decode(bitmap);
              if (result) self.postMessage({ type: 'result', code: result.getText() });
            } catch(err) {
              // NotFoundException â€” ÑˆÑ‚Ñ€Ð¸Ñ…ÐºÐ¾Ð´ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² ÐºÐ°Ð´Ñ€Ðµ, ÑÑ‚Ð¾ Ð½Ð¾Ñ€Ð¼Ð°
            }
          }
        };
      `
      const blob = new Blob([workerCode], { type: 'application/javascript' })
      return new Worker(URL.createObjectURL(blob))
    }

    function openScanner(onScan) {
      const video = document.createElement('video')
      video.autoplay = true
      video.playsInline = true
      video.muted = true
      video.style.cssText = 'width:300px;height:220px;object-fit:cover;border-radius:12px;display:block;'

      // Ð Ð°Ð¼ÐºÐ°-Ð¿Ñ€Ð¸Ñ†ÐµÐ» Ð´Ð»Ñ ÑˆÑ‚Ñ€Ð¸Ñ…ÐºÐ¾Ð´Ð°
      const frame = h('div', { className: 'scanner-frame' },
        video,
        h('div', { className: 'scan-corner' }, h('span', {})),
        h('div', { className: 'scan-line' })
      )
      frame.style.cssText = 'width:300px;height:220px;position:relative;'

      const hint = h('p', { className: 'absolute bottom-32 left-0 right-0 text-center text-white/90 font-bold px-6 z-[210] animate-pulse' }, 'ðŸ“· Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¼ÐµÑ€Ñ‹...')

      let stopped = false
      let rafId = null

      function stopAll() {
        if (stopped) return; stopped = true
        if (rafId) { cancelAnimationFrame(rafId); rafId = null }
        if (_scanStream) { _scanStream.getTracks().forEach(t => t.stop()); _scanStream = null }
        if (_scanWorker) { _scanWorker.terminate(); _scanWorker = null }
        if (ov.parentNode) ov.remove()
      }

      const cancelBtn = h('button', {
        className: 'absolute bottom-12 left-1/2 -translate-x-1/2 px-8 py-3 rounded-2xl bg-[#1f2229] border border-[var(--border-subtle)] text-white font-bold hover:bg-[#2e3447] transition-colors z-[210] flex items-center gap-2 shadow-2xl', type: 'button',
        onClick: stopAll
      }, h('span', { className: 'material-symbols-outlined' }, 'close'), 'ÐžÑ‚Ð¼ÐµÐ½Ð°')

      const ov = h('div', { className: 'fixed inset-0 z-[500] bg-[#0c0d10]/95 backdrop-blur-xl flex flex-col items-center justify-center transition-opacity duration-300' }, frame, hint, cancelBtn)
      document.body.appendChild(ov)

      // Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¼ÐµÑ€Ñ‹
      const constraints = {
        video: {
          facingMode: 'environment',
          width: { ideal: 1280 },
          height: { ideal: 720 }
        }
      }

      navigator.mediaDevices.getUserMedia(constraints).then(stream => {
        if (stopped) { stream.getTracks().forEach(t => t.stop()); return }

        // ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð²ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ñ„Ð¾ÐºÑƒÑ Ð¼ÑÐ³ÐºÐ¾, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ ÑÐ»Ð¾Ð¼Ð°Ñ‚ÑŒ ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð½Ð° iPhone (Safari)
        const track = stream.getVideoTracks()[0];
        if (track && typeof track.applyConstraints === 'function') {
          track.applyConstraints({
            advanced: [{ focusMode: "continuous" }]
          }).catch(() => { /* Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÑƒ: iPhone Safari Ð¼Ð¾Ð¶ÐµÑ‚ ÑÑ‚Ð¾ Ð½Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°Ñ‚ÑŒ */ });
        }

        _scanStream = stream
        video.srcObject = stream

        const detectedCodes = {}
        const isEAN = (code) => /^\d{8,13}$/.test(code)

        const handleResult = (code) => {
          if (!code) return
          detectedCodes[code] = (detectedCodes[code] || 0) + 1
          if (detectedCodes[code] >= (isEAN(code) ? 2 : 3)) {
            stopAll()
            onScan(code)
          }
        }

        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð½Ð°Ñ‚Ð¸Ð²Ð½Ð¾Ð³Ð¾ BarcodeDetector
        if ('BarcodeDetector' in window) {
          hint.textContent = 'ÐÐ°Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð½Ð° ÑˆÑ‚Ñ€Ð¸Ñ…ÐºÐ¾Ð´ (Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÐºÐ°Ð½ÐµÑ€)'
          const detector = new BarcodeDetector({ formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e', 'code_128', 'code_39'] })

          function nativeScanLoop() {
            if (stopped) return
            if (video.videoWidth > 0 && video.readyState === video.HAVE_ENOUGH_DATA) {
              detector.detect(video).then(barcodes => {
                if (barcodes.length > 0) {
                  handleResult(barcodes[0].rawValue)
                }
              }).catch(e => { /* Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð´ÐµÑ‚ÐµÐºÑ‚Ð¾Ñ€Ð° */ })
            }
            rafId = requestAnimationFrame(nativeScanLoop)
          }
          nativeScanLoop()
        } else {
          // Fallback Ð½Ð° ZXing
          _scanWorker = _createScanWorker()
          let workerBusy = false

          _scanWorker.onmessage = (e) => {
            if (e.data.type === 'ready') {
              hint.textContent = 'ÐÐ°Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑˆÑ‚Ñ€Ð¸Ñ…ÐºÐ¾Ð´ Ð² Ñ€Ð°Ð¼ÐºÑƒ'
              const canvas = document.createElement('canvas')
              const ctx = canvas.getContext('2d', { willReadFrequently: true })

              function scanLoop() {
                if (stopped) return
                rafId = requestAnimationFrame(scanLoop)

                if (workerBusy || !video.videoWidth) return
                workerBusy = true

                const vw = video.videoWidth
                const vh = video.videoHeight

                // Ð‘Ð¾Ð»ÐµÐµ ÑˆÐ¸Ñ€Ð¾ÐºÐ°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑˆÑ‚Ñ€Ð¸Ñ…ÐºÐ¾Ð´ Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¿Ð¾Ð¿Ð°Ð» Ð² ÐºÐ°Ð´Ñ€
                const rw = Math.floor(vw * 0.9) // 90% ÑˆÐ¸Ñ€Ð¸Ð½Ñ‹
                const rh = Math.floor(vh * 0.6) // 60% Ð²Ñ‹ÑÐ¾Ñ‚Ñ‹
                const rx = Math.floor(vw * 0.05)
                const ry = Math.floor(vh * 0.2)

                canvas.width = rw
                canvas.height = rh
                ctx.drawImage(video, rx, ry, rw, rh, 0, 0, rw, rh)
                const imgData = ctx.getImageData(0, 0, rw, rh)

                _scanWorker.postMessage(
                  { type: 'decode', pixels: imgData.data, width: rw, height: rh },
                  [imgData.data.buffer] // transferable
                )
              }
              scanLoop()
            }

            if (e.data.type === 'result') {
              workerBusy = false
              handleResult(e.data.code)
            }

            if (e.data.type === 'error') {
              hint.textContent = 'âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° ZXing: ' + e.data.msg
            }

            if (e.data.type !== 'result') workerBusy = false
          }

          _scanWorker.postMessage({ type: 'init' })
        }

      }).catch(err => {
        hint.textContent = 'âš ï¸ ÐÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº ÐºÐ°Ð¼ÐµÑ€Ðµ: ' + err.message
      })
    }

    // â”€â”€ BARCODE MANUAL SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function openBarcodeSearch(onResult) {
      const inp = h('input', { className: 'premium-input w-full mb-4 font-mono text-lg tracking-widest', placeholder: 'Ð¨Ñ‚Ñ€Ð¸Ñ…ÐºÐ¾Ð´ (EAN/UPC)...', type: 'text', inputmode: 'numeric' })
      const resultDiv = h('div', { className: 'mt-4 min-h-[40px] empty:hidden transition-all' })
      let foundItem = null

      const searchBtn = h('button', {
        className: 'w-full py-3 rounded-xl bg-[var(--surface)] border border-[var(--border-subtle)] hover:border-[var(--accent-secondary)]/50 text-white font-bold transition-all flex items-center justify-center gap-2 mb-2', type: 'button',
        onClick: async () => {
          const code = inp.value.trim()
          if (!code) { inp.focus(); return }
          resultDiv.innerHTML = '<div class="w-6 h-6 rounded-full border-2 border-emerald-500/20 border-t-emerald-500 animate-spin mx-auto my-4"></div>'
          searchBtn.disabled = true; searchBtn.classList.add('opacity-50', 'cursor-not-allowed')
          const item = await lookupBarcode(code)
          searchBtn.disabled = false; searchBtn.classList.remove('opacity-50', 'cursor-not-allowed')
          if (item) {
            foundItem = item
            foundItem._code = code
            resultDiv.innerHTML = ''
            const priceText = item.offers && item.offers.length ? h('span', { className: 'ml-2 text-[var(--accent-secondary)] font-black mono text-base' }, `${item.offers[0].price}â‚½`) : ''
            resultDiv.appendChild(h('div', { className: 'bg-[var(--accent-primary)]/10 border border-[var(--accent-primary)]/30 rounded-xl p-4', style: 'animation: slide-up 0.3s ease' },
              h('div', { className: 'flex items-center gap-2 text-[var(--accent-primary)] font-bold mb-2 text-sm uppercase tracking-widest' },
                h('span', { className: 'material-symbols-outlined text-[18px]' }, 'check_circle'), 'Ð¢Ð¾Ð²Ð°Ñ€ Ð½Ð°Ð¹Ð´ÐµÐ½'
              ),
              h('div', { className: 'text-lg font-bold mb-1' }, item.title || code),
              item.brand ? h('div', { className: 'text-sm text-[var(--text-muted)] font-semibold flex items-center mb-4' }, item.brand, priceText) : h('div', { className: 'mb-4' }),
              h('button', {
                className: 'w-full py-3 rounded-xl bg-gradient-to-r from-[var(--accent-primary)] to-[var(--accent-secondary)] text-[#0c0d10] font-black text-sm uppercase tracking-wider hover:opacity-90 transition-opacity', type: 'button',
                onClick: () => { closeModal(); onResult(item, code) }
              }, 'Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð² ÑÐ¿Ð¸ÑÐ¾Ðº')
            ))
          } else {
            foundItem = null
            resultDiv.innerHTML = ''
            resultDiv.appendChild(h('div', { className: 'text-center p-4 rounded-xl border border-red-500/30 bg-red-500/5 mb-3' },
              h('div', { className: 'text-red-400 font-bold mb-1 flex items-center justify-center gap-2' },
                h('span', { className: 'material-symbols-outlined text-[18px]' }, 'error'), 'ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾'
              ),
              h('div', { className: 'text-[var(--text-muted)] text-sm' }, `Ð¢Ð¾Ð²Ð°Ñ€ Â«${code}Â» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² Ð±Ð°Ð·Ðµ.`)
            ))
            resultDiv.appendChild(h('button', {
              className: 'w-full py-3 rounded-xl bg-[#1f2229] border border-[var(--border-subtle)] text-white font-bold text-sm hover:bg-[#2e3447] transition-colors', type: 'button',
              onClick: () => { closeModal(); onResult(null, code) }
            }, 'Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ñ ÑÑ‚Ð¸Ð¼ ÐºÐ¾Ð´Ð¾Ð¼'))
          }
        }
      }, h('span', { className: 'material-symbols-outlined text-[18px]' }, 'search'), 'Ð˜ÑÐºÐ°Ñ‚ÑŒ Ð² Ð±Ð°Ð·Ðµ')

      inp.addEventListener('keydown', e => { if (e.key === 'Enter') searchBtn.click() })

      const scanBtn = h('button', {
        className: 'w-full py-3 rounded-xl bg-gradient-to-tr from-[#1f2229] to-[#16181d] border border-[var(--border-subtle)] text-[#e2e4e9] font-bold transition-all flex items-center justify-center gap-2 group hover:border-[var(--accent-primary)]/50', type: 'button',
        onClick: () => {
          closeModal()
          openScanner(async code => {
            const item = await lookupBarcode(code)
            if (item) onResult(item, code)
            else onResult(null, code)
          })
        }
      }, h('span', { className: 'material-symbols-outlined text-[var(--accent-primary)] group-hover:scale-110 transition-transform' }, 'barcode_scanner'), 'Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ°Ð¼ÐµÑ€Ð¾Ð¹')

      openModal([
        h('div', { className: 'flex justify-between items-center mb-6' },
          h('h2', { className: 'text-xl font-extrabold flex items-center gap-2' },
            h('span', { className: 'material-symbols-outlined text-[var(--text-muted)]' }, 'manage_search'), 'ÐŸÐ¾Ð¸ÑÐº ÑˆÑ‚Ñ€Ð¸Ñ…ÐºÐ¾Ð´Ð°'
          ),
          h('button', { className: 'p-2 rounded-full hover:bg-white/5 transition-colors text-[var(--text-muted)]', onClick: closeModal }, h('span', { className: 'material-symbols-outlined text-[20px]' }, 'close'))
        ),
        inp,
        scanBtn,
        h('div', { className: 'relative my-6 text-center' },
          h('div', { className: 'absolute inset-0 flex items-center' }, h('div', { className: 'w-full border-t border-[var(--border-subtle)]' })),
          h('span', { className: 'relative bg-[var(--surface)] px-4 text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)]' }, 'Ð¸Ð»Ð¸ Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ')
        ),
        searchBtn,
        resultDiv,
      ])
      setTimeout(() => inp.focus(), 80)
    }

    // â”€â”€ ADD ITEM MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showAddItemModal(onAdd, initialState = {}) {
      const nameInp = h('input', { className: 'premium-input w-full col-span-2 md:col-span-1', placeholder: 'ÐœÐ¾Ð»Ð¾ÐºÐ¾, Ñ…Ð»ÐµÐ±...', type: 'text', value: initialState.name || '' })
      const barcodeInp = h('input', { className: 'premium-input w-full font-mono text-sm pl-12', placeholder: 'Ð¨Ñ‚Ñ€Ð¸Ñ…ÐºÐ¾Ð´...', type: 'text', inputmode: 'numeric', value: initialState.barcode || '' })
      const qtyInp = h('input', { className: 'premium-input w-full', type: 'number', min: '0.01', step: '0.01', value: initialState.qty || '1' })
      const unitSel = h('select', { className: 'premium-input w-full appearance-none bg-no-repeat bg-[center_right_1rem] bg-[url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'12\' height=\'8\' viewBox=\'0 0 12 8\'%3E%3Cpath d=\'M1 1l5 5 5-5\' stroke=\'%238892a4\' stroke-width=\'1.5\' fill=\'none\' stroke-linecap=\'round\'/%3E%3C/svg%3E")]' }, ...UNITS.map(u => h('option', { value: u, selected: u === initialState.unit }, u)))
      const priceInp = h('input', { className: 'premium-input w-full font-mono font-bold text-[var(--accent-primary)]', type: 'number', min: '0', placeholder: '0.00', step: '0.01', value: initialState.price || '' })
      let selectedCat = initialState.category || 'other'

      const chips = h('div', { className: 'flex flex-wrap gap-2 mt-1' })
      CATS.forEach(c => {
        const chip = h('button', {
          className: 'px-3 py-1.5 rounded-lg text-[11px] font-black uppercase tracking-wider transition-colors whitespace-nowrap border ' +
            (c.id === selectedCat ? 'bg-[var(--accent-primary)]/10 text-[var(--accent-primary)] border-[var(--accent-primary)]/30' : 'bg-[#1f2229] border-transparent text-[var(--text-muted)] hover:text-white'),
          type: 'button',
          'data-cat': c.id,
          onClick: () => {
            chips.querySelectorAll('button').forEach(x => { x.className = 'px-3 py-1.5 rounded-lg text-[11px] font-black uppercase tracking-wider transition-colors whitespace-nowrap border bg-[#1f2229] border-transparent text-[var(--text-muted)] hover:text-white' })
            chip.className = 'px-3 py-1.5 rounded-lg text-[11px] font-black uppercase tracking-wider transition-colors whitespace-nowrap border bg-[var(--accent-primary)]/10 text-[var(--accent-primary)] border-[var(--accent-primary)]/30'
            selectedCat = c.id
          }
        }, c.label)
        chips.appendChild(chip)
      })

      function applyFoundItem(item, code) {
        const newState = {
          name: nameInp.value,
          barcode: code || barcodeInp.value,
          qty: qtyInp.value,
          unit: unitSel.value,
          price: priceInp.value,
          category: selectedCat
        }

        if (item) {
          newState.name = item.title || code
          if (item.offers && item.offers.length) newState.price = item.offers[0].price || ''
          if (item.category) {
            const catId = CATS.find(c => item.category.toLowerCase().includes(c.id))?.id
            if (catId) newState.category = catId
          }
          toast('âœ“ Ð¢Ð¾Ð²Ð°Ñ€ Ð½Ð°Ð¹Ð´ÐµÐ½', 'ok')
        } else {
          newState.name = newState.name || code
          toast('â“˜ Ð¢Ð¾Ð²Ð°Ñ€ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ', 'err')
        }
        showAddItemModal(onAdd, newState)
      }

      const scanBtn = h('button', {
        className: 'w-12 h-12 rounded-xl bg-gradient-to-tr from-[var(--accent-primary)] to-[var(--accent-secondary)] text-[#0c0d10] flex items-center justify-center shrink-0 shadow-lg shadow-emerald-500/20 active:scale-95 transition-transform hover:opacity-90', type: 'button', title: 'Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑˆÑ‚Ñ€Ð¸Ñ…ÐºÐ¾Ð´',
        onClick: () => {
          closeModal()
          openScanner(async code => { const item = await lookupBarcode(code); applyFoundItem(item, code) })
        }
      }, h('span', { className: 'material-symbols-outlined font-black text-2xl' }, 'barcode_scanner'))

      const barcodeSearchBtn = h('button', {
        className: 'absolute left-3 top-1/2 -translate-y-1/2 text-[var(--text-muted)] hover:text-[var(--accent-primary)] transition-colors flex z-10', type: 'button', title: 'ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ ÑˆÑ‚Ñ€Ð¸Ñ…ÐºÐ¾Ð´Ñƒ',
        onClick: () => { closeModal(); openBarcodeSearch((item, code) => applyFoundItem(item, code)) }
      }, h('span', { className: 'material-symbols-outlined', style: 'font-size:20px' }, 'search'))

      const addBtn = h('button', {
        className: 'w-full py-3.5 rounded-xl bg-gradient-to-r from-[var(--accent-primary)] to-[var(--accent-secondary)] text-[#0c0d10] font-black tracking-wider uppercase text-sm hover:opacity-90 active:scale-[0.98] transition-all flex items-center justify-center gap-2 mt-2', type: 'button',
        onClick: () => {
          const name = nameInp.value.trim(); if (!name) { nameInp.focus(); return }
          onAdd({
            id: genId(), name, barcode: barcodeInp.value.trim(), qty: parseFloat(qtyInp.value) || 1, unit: unitSel.value,
            price: parseFloat(priceInp.value) || 0, category: selectedCat, done: false
          })
          closeModal()
        }
      }, h('span', { className: 'material-symbols-outlined text-[18px]' }, 'add_circle'), 'Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€')

      nameInp.addEventListener('keydown', e => { if (e.key === 'Enter') addBtn.click() })

      const label = (text) => h('label', { className: 'block text-[10px] font-black text-[var(--text-muted)] uppercase tracking-widest mb-1.5 ml-1' }, text)

      openModal([
        h('div', { className: 'flex items-center gap-3 mb-6' },
          h('span', { className: 'material-symbols-outlined text-[var(--accent-primary)] text-3xl' }, 'shopping_cart'),
          h('h2', { className: 'text-xl font-extrabold' }, 'ÐÐ¾Ð²Ñ‹Ð¹ Ñ‚Ð¾Ð²Ð°Ñ€')
        ),
        h('div', { className: 'space-y-4 max-h-[80vh] overflow-y-auto pr-1 no-scrollbar' },
          // â”€â”€ ÐšÐ½Ð¾Ð¿ÐºÐ° ÑÐºÐ°Ð½ÐµÑ€Ð° â€” ÐºÑ€ÑƒÐ¿Ð½Ð°Ñ, Ð²ÑÐµÐ³Ð´Ð° Ð²Ð¸Ð´Ð½Ð° Ð½Ð° Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ðµ
          h('button', {
            className: 'w-full py-4 rounded-2xl bg-gradient-to-tr from-[#3df29c] to-[#35fada] text-[#020202] font-black flex items-center justify-center gap-3 text-base active:scale-[0.98] transition-all shadow-lg shadow-[#3df29c]/20',
            type: 'button',
            onClick: () => {
              closeModal()
              openScanner(async code => { const item = await lookupBarcode(code); applyFoundItem(item, code) })
            }
          },
            h('span', { className: 'material-symbols-outlined text-2xl' }, 'barcode_scanner'),
            'Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑˆÑ‚Ñ€Ð¸Ñ…ÐºÐ¾Ð´'
          ),
          h('div', {}, label('ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ'), nameInp),
          h('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-3' },
            h('div', {}, label('Ð¨Ñ‚Ñ€Ð¸Ñ…ÐºÐ¾Ð´'),
              h('div', { className: 'relative' }, barcodeSearchBtn, barcodeInp)
            ),
            h('div', {}, label('Ð¦ÐµÐ½Ð° (â‚½)'), priceInp)
          ),
          h('div', { className: 'grid grid-cols-2 gap-3' },
            h('div', {}, label('Ð•Ð´Ð¸Ð½Ð¸Ñ†Ð°'), unitSel),
            h('div', {}, label('ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾'), qtyInp)
          ),
          h('div', { className: 'pt-2' }, label('ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ'), chips),
          h('div', { className: 'pt-2' }, addBtn),
          h('button', { className: 'w-full py-2.5 rounded-xl border border-[var(--border-subtle)] text-[var(--text-muted)] font-bold text-xs hover:bg-[#2e3447] hover:text-white transition-colors uppercase tracking-widest', type: 'button', onClick: closeModal }, 'ÐžÑ‚Ð¼ÐµÐ½Ð°')
        )
      ])
      setTimeout(() => nameInp.focus(), 80)
    }

    // â”€â”€ LIST DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderListDetail(container, listDoc, onBack) {
      let items = [...(listDoc.items || [])]
      let filterCat = 'all'

      async function save(newItems) {
        items = newItems
        try { await updateDoc(doc(db, 'lists', listDoc.id), { items: newItems }) }
        catch (e) { toast('Error saving', 'err') }
      }

      let isDetailActive = true

      const showAdd = () => showAddItemModal(async item => {
        await save([...items, item]); render(); toast('Item added âœ“', 'ok')
      })

      const fabListener = () => { if (isDetailActive) showAdd() }
      document.addEventListener('app-fab-click', fabListener)

      function render() {
        container.innerHTML = ''
        const total = items.reduce((s, it) => s + (it.price * it.qty), 0)
        const doneCount = items.filter(it => it.done).length
        const count = items.length
        const pct = count ? (doneCount / count) * 100 : 0

        const hdr = h('div', { className: 'flex items-center justify-between mb-10' })
        const left = h('div', { className: 'flex items-center gap-4' },
          h('button', { className: 'w-12 h-12 rounded-full bg-[#111] border border-[var(--border-subtle)] flex items-center justify-center', onClick: onBack },
            h('span', { className: 'material-symbols-outlined' }, 'arrow_back')
          ),
          h('h2', { className: 'text-3xl font-black truncate max-w-[180px]' }, listDoc.name)
        )
        const right = h('div', { className: 'flex items-center gap-2' },
          h('button', { className: 'btn-action-circle', onClick: sendWA }, h('span', { className: 'material-symbols-outlined text-[20px]' }, 'share')),
          h('button', {
            className: 'btn-action-circle', onClick: () => {
              closeModal()
              openScanner(async code => { const item = await lookupBarcode(code); applyFoundItemToList(item, code) })
            }
          }, h('span', { className: 'material-symbols-outlined text-[20px]' }, 'qr_code_scanner'))
        )
        hdr.append(left, right)
        container.appendChild(hdr)

        const usedCats = [...new Set(items.map(it => it.category || 'other'))]
        if (usedCats.length > 0) {
          const pills = h('div', { className: 'flex items-center gap-3 mb-10 overflow-x-auto no-scrollbar pb-2' })
          const mk = (id, label) => h('button', {
            className: 'px-6 py-2.5 rounded-full text-sm font-black transition-all whitespace-nowrap ' +
              (filterCat === id ? 'bg-[#3df29c] text-[#020202]' : 'bg-[#111111] text-[var(--text-muted)] border border-[var(--border-subtle)]'),
            onClick: () => { filterCat = id; render() }
          }, label)
          pills.appendChild(mk('all', 'All Items'))
          CATS.filter(c => usedCats.includes(c.id)).forEach(c => pills.appendChild(mk(c.id, c.label)))
          container.appendChild(pills)
        }

        const filtered = filterCat === 'all' ? items : items.filter(it => (it.category || 'other') === filterCat)
        const listContainer = h('div', { className: 'glass-card p-2 mb-10' })

        if (items.length === 0) {
          listContainer.appendChild(h('div', { className: 'text-center py-20 text-[var(--text-muted)] font-black uppercase tracking-widest' }, 'List is empty'))
        } else {
          filtered.forEach(item => {
            const row = h('div', { className: 'p-4 flex items-center gap-4 transition-all ' + (item.done ? 'opacity-30' : '') })

            const checkbox = h('button', {
              className: 'w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all ' +
                (item.done ? 'bg-[#3df29c] border-[#3df29c]' : 'bg-[#111111] border-[var(--border-subtle)]'),
              onClick: () => save(items.map(it => it.id === item.id ? { ...it, done: !it.done } : it)).then(render)
            }, item.done ? h('span', { className: 'material-symbols-outlined text-[#020202] text-xl font-black' }, 'check') : null)

            const info = h('div', { className: 'flex-1 min-w-0' },
              h('div', { className: 'text-lg font-bold ' + (item.done ? 'line-through' : '') }, item.name),
              h('div', { className: 'text-[10px] uppercase font-black tracking-widest text-[var(--text-muted)] mt-1' }, `${item.qty} UNITS â€¢ ${item.category || 'OTHER'}`),
              item.barcode ? h('div', { className: 'flex items-center gap-1.5 mt-1.5' },
                h('span', { className: 'material-symbols-outlined text-[12px] text-[var(--text-muted)]' }, 'barcode'),
                h('a', {
                  className: 'font-mono text-[11px] text-[var(--accent-secondary)] tracking-widest bg-white/5 px-2 py-0.5 rounded-lg hover:bg-white/10 hover:text-white transition-colors cursor-pointer',
                  href: `https://www.google.com/search?q=${encodeURIComponent(item.barcode)}&tbm=isch`,
                  target: '_blank',
                  rel: 'noopener'
                }, item.barcode)
              ) : null
            )

            const price = h('div', { className: 'text-right flex items-center gap-3' },
              h('div', { className: 'font-black text-white text-lg mono' },
                item.price > 0 ? `${(item.price * item.qty).toLocaleString()} ` : '',
                item.price > 0 ? h('span', { className: 'text-[var(--accent-primary)] text-sm ml-1' }, 'P') : ''
              ),
              h('button', {
                className: 'text-[var(--text-muted)] hover:text-red-400 p-2',
                onClick: () => { if (confirm('Delete?')) save(items.filter(it => it.id !== item.id)).then(render) }
              }, h('span', { className: 'material-symbols-outlined text-[20px]' }, 'delete'))
            )

            row.append(checkbox, info, price)
            listContainer.appendChild(row)
          })
        }
        container.appendChild(listContainer)

        // Floating FAB for adding items
        const fab = h('button', {
          className: 'fixed bottom-24 right-5 z-[300] w-16 h-16 rounded-2xl bg-gradient-to-tr from-[#3df29c] to-[#35fada] flex items-center justify-center shadow-2xl shadow-[#3df29c]/30 text-[#020202] transform transition-transform active:scale-90 hover:opacity-90',
          onClick: showAdd
        }, h('span', { className: 'material-symbols-outlined font-black text-3xl' }, 'add'))
        container.appendChild(fab)

        // Summary
        const summary = h('div', { className: 'glass-card p-8 text-center mb-10' })
        summary.append(
          h('div', { className: 'text-[10px] font-black uppercase tracking-[0.2em] text-[var(--text-muted)] mb-4' }, 'ITEMS TOTAL'),
          h('div', { className: 'text-5xl font-black mb-10 flex items-center justify-center gap-4' },
            total.toLocaleString(),
            h('span', { className: 'text-[#3df29c] text-3xl mt-2' }, 'P')
          ),
          h('div', { className: 'grid grid-cols-2 gap-6' },
            h('button', {
              className: 'py-5 rounded-2xl bg-[#111] border border-[var(--border-subtle)] font-black text-sm flex items-center justify-center gap-2',
              onClick: () => save(items.map(it => ({ ...it, done: false }))).then(render)
            }, h('span', { className: 'material-symbols-outlined' }, 'refresh'), 'Reset'),
            h('button', {
              className: 'py-5 rounded-2xl bg-[#3df29c] text-[#020202] font-black text-sm flex items-center justify-center gap-2',
              onClick: sendWA
            }, h('span', { className: 'material-symbols-outlined' }, 'send'), 'Share List')
          )
        )
        container.appendChild(summary)
      }

      function applyFoundItemToList(item, code) {
        const newItem = { id: genId(), name: (item && item.title) || code || 'Item', barcode: code || '', qty: 1, unit: 'ÑˆÑ‚.', price: (item && item.offers && item.offers[0]) ? item.offers[0].price : 0, category: (item && item.category) || 'other', done: false }
        save([...items, newItem]).then(render)
        toast(item ? 'âœ“ Product found & added' : 'â“˜ Added with barcode', item ? 'ok' : 'err')
      }

      function sendWA() {
        const nd = items.filter(it => !it.done)
        const total = items.reduce((s, it) => s + (it.price * it.qty), 0)
        const text = `ðŸ›’ *${listDoc.name}*\n\n`
          + (nd.length ? nd.map(it => `â€¢ ${it.name} â€” ${it.qty} ${it.unit}${it.price ? ` (${(it.price * it.qty).toFixed(0)}â‚½)` : ''}`)
            .join('\n') : '(Ð²ÑÐµ ÐºÑƒÐ¿Ð»ÐµÐ½Ð¾ ðŸŽ‰)')
          + (total > 0 ? `\n\nðŸ’° *Ð˜Ñ‚Ð¾Ð³Ð¾: ${total.toFixed(0)}â‚½*` : '')
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank', 'noopener')
      }

      render()
      return () => { isDetailActive = false; document.removeEventListener('app-fab-click', fabListener) }
    }

    // â”€â”€ HOME PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderHomePage(container, uid) {
      let lists = []
      let openDoc = null

      function draw() {
        container.innerHTML = ''
        if (openDoc) {
          const live = lists.find(l => l.id === openDoc.id) || openDoc
          renderListDetail(container, live, () => { openDoc = null; draw() })
          return
        }

        container.appendChild(h('div', { className: 'mb-8 animate-fade-in text-left' },
          h('h1', { className: 'text-4xl font-black tracking-tight mb-2' }, 'My Shopping Lists'),
          h('p', { className: 'text-[var(--text-muted)] text-base font-bold' }, 'Manage your items and household needs')
        ))

        container.appendChild(h('button', {
          className: 'w-full py-5 mb-10 rounded-2xl bg-[#3df29c] text-[#020202] font-black flex justify-center items-center gap-2 shadow-xl shadow-[#3df29c]/10 text-lg hover:opacity-90 active:scale-[0.98] transition-all',
          type: 'button', onClick: showCreate
        },
          h('span', { className: 'material-symbols-outlined font-black' }, 'add'),
          'New List'
        ))

        if (!lists.length) {
          container.appendChild(h('div', { className: 'text-center py-12' },
            h('div', { className: 'w-24 h-24 mx-auto mb-6 rounded-3xl bg-[#111111] border border-[var(--border-subtle)] flex items-center justify-center' },
              h('span', { className: 'material-symbols-outlined text-[48px] text-[#555555]' }, 'shopping_basket')
            ),
            h('h3', { className: 'text-xl font-bold mb-2 text-white' }, 'No lists yet'),
            h('p', { className: 'text-[var(--text-muted)]' }, 'Create your first one above')
          ))
          return
        }

        const todayItems = lists.filter(l => l.createdAt && (Date.now() - l.createdAt.toDate()) < 86400000)
        const olderItems = lists.filter(l => l.createdAt && (Date.now() - l.createdAt.toDate()) >= 86400000)

        const renderSection = (title, items) => {
          if (!items.length) return
          container.appendChild(h('div', { className: 'text-[10px] font-black uppercase tracking-[0.2em] text-[#3df29c] mb-6 mt-4 ml-1 pl-1 border-l-2 border-[#3df29c]/30' }, title))

          items.forEach((list, i) => {
            const total = (list.items || []).reduce((s, it) => s + (it.price * it.qty), 0)
            const done = (list.items || []).filter(it => it.done).length
            const count = (list.items || []).length
            const pct = count ? (done / count) * 100 : 0
            const delay = (i * 0.05).toFixed(2)

            const segments = h('div', { className: 'segmented-bar mb-6' })
            for (let s = 0; s < 10; s++) {
              const isFilled = (s + 1) <= Math.ceil(pct / 10)
              segments.appendChild(h('div', { className: 'segment ' + (isFilled ? 'filled' : '') }))
            }

            const avatars = h('div', { className: 'avatar-stack' },
              h('div', { className: 'avatar bg-blue-500' }),
              h('div', { className: 'avatar bg-teal-500' }),
              h('div', { className: 'avatar bg-[#222] text-[8px] flex items-center justify-center font-bold text-[var(--accent-primary)]' }, `+2`),
              h('span', { className: 'ml-3 text-[11px] font-bold text-[var(--text-muted)]' }, 'Shared with Family')
            )

            const card = h('div', {
              className: 'glass-card p-6 mb-6 cursor-pointer group active:scale-[0.99] transition-all animate-fade-in-up',
              style: `animation-delay: ${delay}s;`,
              onClick: () => { openDoc = list; draw() }
            },
              h('div', { className: 'flex justify-between items-start mb-6' },
                h('div', { className: 'flex-1 min-w-0 pr-4' },
                  h('h3', { className: 'text-2xl font-black mb-4 group-hover:text-[var(--accent-primary)] transition-colors truncate' }, list.name),
                  avatars
                ),
                h('button', {
                  className: 'text-[var(--text-muted)] hover:text-red-400 hover:bg-red-400/10 transition-colors p-2 rounded-xl',
                  onClick: e => { e.stopPropagation(); if (confirm(`Delete "${list.name}"?`)) deleteDoc(doc(db, 'lists', list.id)) }
                }, h('span', { className: 'material-symbols-outlined text-[20px]' }, 'delete'))
              ),
              segments,
              h('div', { className: 'flex justify-between items-end' },
                h('div', {},
                  h('div', { className: 'text-[10px] font-black uppercase tracking-widest text-[var(--text-muted)] mb-2' }, 'PROGRESS'),
                  h('div', { className: 'text-[11px] font-black' },
                    h('span', { className: 'text-[var(--accent-primary)]' }, done),
                    h('span', { className: 'text-[var(--text-muted)] mx-1' }, '/'),
                    h('span', { className: 'text-[var(--accent-primary)]' }, `${count} ITEMS`)
                  )
                ),
                h('div', { className: 'text-right' },
                  h('div', { className: 'flex items-center gap-2 text-white font-black text-xl mb-3' },
                    h('span', { className: 'material-symbols-outlined text-[var(--text-muted)] text-lg' }, 'payments'),
                    `${total.toLocaleString()} `, h('span', { className: 'currency-p' }, 'P')
                  ),
                  h('div', { className: 'px-3 py-1 bg-[#1a1a1a] rounded-lg text-[10px] font-black tracking-widest text-[#3df29c] uppercase inline-block' }, 'ACTIVE')
                )
              )
            )
            container.appendChild(card)
          })
        }

        renderSection('TODAY', todayItems.length ? todayItems : lists)
        renderSection('YESTERDAY', olderItems)
      }

      function showCreate() {
        const inp = h('input', { className: 'premium-input w-full mb-6', placeholder: 'List name...', type: 'text' })
        const ok = h('button', {
          className: 'w-full py-4 rounded-2xl bg-[#3df29c] text-[#020202] font-black uppercase tracking-widest hover:opacity-90 transition-opacity flex items-center justify-center gap-2',
          type: 'button',
          onClick: async () => {
            const name = inp.value.trim(); if (!name) { inp.focus(); return }
            closeModal()
            try { await addDoc(collection(db, 'lists'), { uid, name, items: [], createdAt: serverTimestamp() }); toast('List created', 'ok') }
            catch (e) { toast(e.message, 'err') }
          }
        }, h('span', { className: 'material-symbols-outlined' }, 'add_circle'), 'Create')
        inp.addEventListener('keydown', e => { if (e.key === 'Enter') ok.click() })
        openModal([
          h('div', { className: 'text-xl font-black mb-6 flex items-center gap-3' }, h('span', { className: 'material-symbols-outlined text-[var(--accent-primary)]' }, 'playlist_add'), 'New Shopping List'),
          inp,
          h('div', { className: 'grid grid-cols-2 gap-4' },
            h('button', { className: 'py-4 rounded-2xl bg-[#111111] border border-[var(--border-subtle)] text-white font-black hover:bg-[#1a1a1a] transition-colors', type: 'button', onClick: closeModal }, 'CANCEL'),
            ok
          )
        ])
        setTimeout(() => inp.focus(), 60)
      }

      const fabListener = () => { if (curPage === 'home') showCreate() }
      document.addEventListener('app-fab-click', fabListener)

      const q = query(collection(db, 'lists'), where('uid', '==', uid), orderBy('createdAt', 'desc'))
      const unsub = onSnapshot(q, snap => {
        lists = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        draw()
      }, err => {
        if (err.code === 'failed-precondition') {
          container.innerHTML = '<div class="glass-card p-6">Index required in Firestore.</div>'
        } else { toast(err.message, 'err') }
      })

      return () => {
        unsub()
        document.removeEventListener('app-fab-click', fabListener)
      }
    }

    // â”€â”€ ABOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderAbout(c) {
      c.innerHTML = ''
      c.appendChild(h('div', { className: 'hero', style: 'padding-bottom:16px' }, h('h1', {}, 'Ðž ', h('span', {}, 'ÐšÑƒÐ¿Ð¸ÐºÐµ')), h('p', {}, 'Ð£Ð¼Ð½Ñ‹Ð¹ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº Ð´Ð»Ñ Ð¿Ð¾Ñ…Ð¾Ð´Ð° Ð² Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½')))
      const card = h('div', { className: 'card' })
      card.innerHTML = ''
      card.appendChild(h('div', { className: 'ps' }, h('h2', {}, 'Ð§Ñ‚Ð¾ Ñ‚Ð°ÐºÐ¾Ðµ ÐšÑƒÐ¿Ð¸ÐºÐ°?'), h('p', {}, 'ÐšÑƒÐ¿Ð¸ÐºÐ° â€” ÑƒÐ´Ð¾Ð±Ð½Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ ÑÐ¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐ¿Ð¸ÑÐºÐ¾Ð² Ð¿Ð¾ÐºÑƒÐ¿Ð¾Ðº. Ð Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð¿Ñ€ÑÐ¼Ð¾ Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ, Ð½Ðµ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð¸ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ‡ÐµÑ€ÐµÐ· Ð¾Ð±Ð»Ð°ÐºÐ¾ Firebase.')))
      card.appendChild(h('div', { className: 'divider' }))
      card.appendChild(h('div', { className: 'ps' }, h('h2', {}, 'Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸'), h('p', {}, 'ÐÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑÐ¿Ð¸ÑÐºÐ¾Ð², ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð², Ð¿Ð¾Ð´ÑÑ‡Ñ‘Ñ‚ ÑÑƒÐ¼Ð¼Ñ‹, Ð·Ð°Ñ‡Ñ‘Ñ€ÐºÐ¸Ð²Ð°Ð½Ð¸Ðµ ÐºÑƒÐ¿Ð»ÐµÐ½Ð½Ñ‹Ñ… Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¹, ÑÐºÐ°Ð½ÐµÑ€ ÑˆÑ‚Ñ€Ð¸Ñ…ÐºÐ¾Ð´Ð° Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¿Ð¸ÑÐºÐ° Ð² WhatsApp.')))
      card.appendChild(h('div', { className: 'divider' }))
      card.appendChild(h('div', { className: 'ps' }, h('h2', {}, 'ÐŸÑ€Ð¸Ð²Ð°Ñ‚Ð½Ð¾ÑÑ‚ÑŒ'), h('p', {}, 'Ð”Ð°Ð½Ð½Ñ‹Ðµ Ñ…Ñ€Ð°Ð½ÑÑ‚ÑÑ Ð°Ð½Ð¾Ð½Ð¸Ð¼Ð½Ð¾ Ð² Firebase, Ð½Ðµ Ð¿Ñ€Ð¸Ð²ÑÐ·Ð°Ð½Ñ‹ Ðº email Ð¸Ð»Ð¸ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ñƒ. ÐÐ¸ÐºÐ°ÐºÐ¾Ð¹ Ñ€ÐµÐºÐ»Ð°Ð¼Ñ‹ Ð¸ Ñ‚Ñ€ÐµÐºÐ¸Ð½Ð³Ð°.')))
      c.appendChild(card)
    }

    // â”€â”€ CONTACTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderContacts(c) {
      c.innerHTML = ''
      c.appendChild(h('div', { className: 'hero', style: 'padding-bottom:16px' }, h('h1', {}, h('span', {}, 'ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹')), h('p', {}, 'Ð¡Ð²ÑÐ¶Ð¸Ñ‚ÐµÑÑŒ Ñ Ð½Ð°Ð¼Ð¸ Ð»ÑŽÐ±Ñ‹Ð¼ ÑƒÐ´Ð¾Ð±Ð½Ñ‹Ð¼ ÑÐ¿Ð¾ÑÐ¾Ð±Ð¾Ð¼')))
      const card = h('div', { className: 'card' });
      [['ðŸ“§', 'Email', 'info@kupika.app', 'mailto:info@kupika.app'],
      ['ðŸ’¬', 'WhatsApp', '+7 900 000-00-00', 'https://wa.me/79000000000'],
      ['ðŸŒ', 'Ð¡Ð°Ð¹Ñ‚', 'kupika.app', 'https://kupika.app']
      ].forEach(([icon, lbl, val, href]) => {
        card.appendChild(h('div', { className: 'contact-row' },
          h('div', { className: 'contact-icon' }, icon),
          h('div', {}, h('div', { className: 'contact-lbl' }, lbl), h('div', { className: 'contact-val' }, h('a', { href, target: '_blank', rel: 'noopener' }, val)))
        ))
      })
      c.appendChild(card)
    }

    // â”€â”€ APP SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function buildApp(uid) {
      const app = document.getElementById('app')
      app.innerHTML = ''
      app.className = 'flex flex-col min-h-screen bg-[var(--bg-deep)] text-white overflow-x-hidden'
      let curPage = 'home', cleanup = null

      const BN = [
        { id: 'home', label: 'LISTS', icon: 'grid_view' },
        { id: 'history', label: 'HISTORY', icon: 'history' },
        { id: 'add', label: '', icon: 'add' },
        { id: 'friends', label: 'FRIENDS', icon: 'group' },
        { id: 'settings', label: 'SETTINGS', icon: 'settings' }
      ]

      const hdr = h('header', { className: 'sticky top-0 z-[100] h-16 bg-[var(--bg-deep)] flex items-center justify-between px-6' })
      const logoIcon = h('div', { className: 'w-10 h-10 rounded-xl bg-[#37ff9d]/20 border border-[#37ff9d]/30 flex items-center justify-center text-[#37ff9d]' },
        h('span', { className: 'material-symbols-outlined text-xl font-bold' }, 'shopping_bag')
      )
      const logoText = h('span', { className: 'text-xl font-extrabold tracking-tight text-white ml-2' }, 'Kupika')
      const logo = h('div', { className: 'flex items-center cursor-pointer', onClick: () => go('home') }, logoIcon, logoText)

      const hdrRight = h('div', { className: 'flex items-center gap-4' },
        h('button', { className: 'text-[var(--text-muted)] p-1 hover:text-white transition-colors' }, h('span', { className: 'material-symbols-outlined' }, 'search')),
        h('div', { className: 'w-8 h-8 rounded-full bg-[#1a1a1a] border border-[var(--border-subtle)] flex items-center justify-center text-[10px] font-black' }, 'JD')
      )
      hdr.append(logo, hdrRight)

      const main = h('main', { className: 'flex-1 p-6 md:px-10 max-w-2xl mx-auto w-full pb-32 animate-fade-in' })
      const bnav = h('nav', { className: 'fixed bottom-0 left-0 right-0 z-[200] h-20 bg-[#0c0c0c] border-t border-[var(--border-subtle)] flex items-center justify-between px-4 sm:px-10' })

      function renderBN() {
        bnav.innerHTML = ''
        BN.forEach((n, idx) => {
          if (idx === 2) {
            // Spacer where FAB used to be
            bnav.appendChild(h('div', { className: 'w-14' }))
            return
          }
          const isActive = curPage === n.id
          const btn = h('button', {
            className: 'flex flex-col items-center gap-1 transition-all ' + (isActive ? 'text-[var(--accent-primary)]' : 'text-[#555555]'),
            onClick: () => go(n.id)
          },
            h('span', { className: 'material-symbols-outlined text-[24px]' }, n.icon),
            h('span', { className: 'text-[9px] font-black tracking-widest uppercase' }, n.label)
          )
          bnav.appendChild(btn)
        })
      }

      function go(page) {
        if (cleanup) cleanup(); curPage = page
        renderBN(); main.innerHTML = ''
        window.scrollTo(0, 0)
        if (page === 'home') cleanup = renderHomePage(main, uid)
        else if (page === 'history') main.innerHTML = '<div class="text-center py-20 text-[var(--text-muted)]">History coming soon...</div>'
        else if (page === 'friends') main.innerHTML = '<div class="text-center py-20 text-[var(--text-muted)]">Friends coming soon...</div>'
        else if (page === 'settings') main.innerHTML = '<div class="text-center py-20 text-[var(--text-muted)]">Settings coming soon...</div>'
      }

      app.append(hdr, main, bnav)
      go('home')
    }

    // â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    onAuthStateChanged(auth, user => {
      if (user) { buildApp(user.uid) }
      else {
        signInAnonymously(auth).catch(err => {
          document.getElementById('app').innerHTML =
            `<div style="text-align:center;padding:60px 20px;">
          <div style="font-size:48px;margin-bottom:16px;">âš ï¸</div>
          <div style="color:#f87171;font-weight:800;font-size:18px;margin-bottom:10px;">ÐžÑˆÐ¸Ð±ÐºÐ° Firebase</div>
          <div style="color:#8892a4;font-size:14px;line-height:1.7;">${err.message}<br><br>
          ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð» Ð¸ Ð²ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ ÑÐ²Ð¾Ð¹ <b style="color:#e8eaf0">firebaseConfig</b> Ð² Ð½Ð°Ñ‡Ð°Ð»Ð¾ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°.</div>
        </div>`
        })
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.21.3/umd/index.min.js"></script>
</body>

</html>